---
title: "Download a species list and cross-reference with conservation status lists in R"
description: |
  Knowing what species have been observed in a local area is a regular task for ecosystem management. Here we show how to make a species list with galah and how to cross-reference this list with threatened and sensitive species lists. We then show how to visualise this information as a waffle chart using {waffle} & {ggplot2}.
author:
  - name: "Dax Kellie"
  - name: "Amanda Buyan"
date: "2024-05-02"
title-block-banner: "#B8573E"
toc: true
toc-location: left
toc-depth: 2
filters:
   - lightbox
lightbox: auto
categories:
  - Eukaryota
  - Animalia
  - Plantae
  - Summaries
  - R
image: waffle_yass.png
freeze: true
draft: true
editor_options: 
  chunk_output_type: console
---

```{r}
#| include: false
library(htmltools)
```

<!-- remove metadata section -->

```{=html}
<style>
  #title-block-header.quarto-title-block.default .quarto-title-meta {
      display: none;
  }
</style>
```
<!-- Author card -->

::: author-card
::: author-card-text
#### Author

[Dax Kellie](https://labs.ala.org.au/about/Kellie_Dax/)\
[Amanda Buyan](https://labs.ala.org.au/about/Buyan_Amanda/)

#### Date

2 May 2024
:::

::: author-card-image
```{r, out.width='120px', out.extra='style="clip-path: circle();"', echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/dax.jpg")
```
:::

::: author-card-image
```{r, out.width='120px', out.extra='style="clip-path: circle();"', echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/amanda.jpg")
```
:::
:::

<!------------------------ Post starts here ------------------------>

Knowing what species inhabit an area is important for conservation and ecosystem management. In particular, it can help us find how many known species are in a given area, and whether any species are threatened or endangered.

In this post, we will use the [galah](https://galah.ala.org.au/R/), [waffle](https://github.com/hrbrmstr/waffle) and [ggplot2](https://ggplot2.tidyverse.org/) packages to show you how to download a list of species within the Yass Valley in 2023, cross-reference this list with state-wide conservation status lists, and visualise the number of threatened and sensitive species in the region. 

::: aside

For those unfamiliar with Australian geography, Yass Valley is located here:

```{r}
#| echo: false
#| warning: false
#| message: false
library(ozmaps)
library(dplyr)
library(sf)
library(ggplot2)

lga_wgs84 <- ozmap_data(data = "abs_lga") |> 
  sf::st_transform(4326)

yass_wgs84 <- ozmap_data(data = "abs_lga") |>
  dplyr::filter(stringr::str_detect(NAME, "Yass")) |>
  sf::st_transform(4326)

#create the start and end points of the label arrow
arrows <- 
  tibble(
    x1 = c(154),
    x2 = c(149),
    y1 = c(-40),
    y2 = c(-36))

map_highlight <- ggplot() + 
  geom_sf(data = lga_wgs84,
          fill = "white",
          colour = "grey65") +
  geom_sf(data = yass_wgs84, 
          fill = "#E06E53",
          colour = "#E06E53")

map_highlight + 
  theme_void() + 
  geom_curve(
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), 
    linewidth = 1.5,
    color = "gray10", 
    curvature = -0.3) + 
  annotate("text", x = 157, y = -41, label = "Yass Valley", size = 10) 
```

:::

# Download a list of species

There are two ways to narrow a download to return information for a specific region:  

  * Using galah (`fields` are downloaded from the ALA)
  * Using a shapefile
  
The method you choose depends on whether the region you wish to return species for is already in galah, or whether you wish to filter for a more specific area defined by a shapefile.

Let's first load our packages. To download species lists, you will also need to enter a registered email with the ALA using `galah_config()`.

```{r}
#| eval: false
library(dplyr)
library(ggplot2)
library(readr)
library(sf)
library(rmapshaper)
library(here)
library(galah)

galah_config(email = "your-email-here")
```

```{r}
#| echo: false
#| warning: false
#| message: false
library(dplyr)
library(ggplot2)
library(readr)
library(sf)
library(rmapshaper)
library(here)
library(galah)
galah_config(email = "dax.kellie@csiro.au", verbose = FALSE)
```


::: {.panel-tabset .nav-pills}

# galah

### Search for fields

To find what exists in galah to help us narrow our query, we can use the `search_all()` function to search for available fields. A **field** in galah refers to a column or layer stored in a living atlas. Let's do a text search to find what fields contain information on "Local Government Areas".

```{r}
search_all(fields, "Local Government Areas")
```

The field `cl11170`[^1] contains the most recent available data (from 2023). We can preview what values are *within* field `cl11170` using `show_values()`.

[^1]: Each spatial layer has a two letter code, along with a number to identify it. The abbreviations are as follows:
  * `cl` = contextual layer (i.e. boundaries of LGAs, Indigenous Protected Areas, States/Territories etc.)  
  * `11170` = number associated with the spatial layer in the atlas

```{r}
search_all(fields, "cl11170") |>
  show_values()
```

There are lots of Local Government Areas! To check whether Yass Valley is included, we can do a text search for values that match "yass".

```{r}
search_all(fields, "cl11170") |>
  search_values("yass")
```


### Download data

Using the `field` and `value` returned above, we can now build our query. We begin our query with `galah_call()` and filter to only Yass Valley in the year 2024. We then specify we wish to return a species list by ending our query with `atlas_species()`. 

```{r}
species_yass <- galah_call() |>
  filter(cl11170 == "Yass Valley",
         year == 2024) |>
  atlas_species()

species_yass
```

It's also possible to group by `scientificName` (genus + species name) and return the observations counts by ending our query with `atlas_counts()`.

```{r}
species_counts <- galah_call() |>
  filter(cl11170 == "Yass Valley",
         year == 2024) |>
  group_by(scientificName) |>
  atlas_counts()

species_counts
```


# External shapefile

### Download shapefile

To retrieve the spatial outline of Yass Valley, let's download the latest Local Government Areas data from the [Australian Bureau of Statistics Digital Boundary files page](https://www.abs.gov.au/statistics/standards/australian-statistical-geography-standard-asgs-edition-3/jul2021-jun2026/access-and-downloads/digital-boundary-files). Find "Local Government Areas - 2023 - Shapefile" and click "Download ZIP". Save the zip folder in your current directory and unzip it.

Let's read the file into R. We will also simplify the shapefile[^simplify] using `ms_simplify()` from the [rmapshaper package](https://andyteucher.ca/rmapshaper/) because complex shapefiles can sometimes cause problems with sending queries to the ALA.

[^simplify]: Simplifying a shapefile removes the number of total points that draw the shape outline.

```{r}
#| eval: false
lga <- sf::st_read(here("LGA_2023_AUST_GDA2020.shp")) |>
  rmapshaper::ms_simplify(keep = 0.01)
lga
```

```{r}
#| warning: false
#| message: false
#| echo: false
lga <- sf::st_read(here("posts",
                        "data",
                        "LGA_2023",
                        "LGA_2023_AUST_GDA2020.shp"),
                   quiet = TRUE) |>
  rmapshaper::ms_simplify(keep = 0.01)
lga
```


Now let's transform our shapefile to use the Coordinate Reference System (CRS) [EPSG](https://en.wikipedia.org/wiki/EPSG_Geodetic_Parameter_Dataset):4326 (the standard used in cartography and GPS, also known as [WGS84](https://en.wikipedia.org/wiki/World_Geodetic_System)) so that it matches the projection of our data from the ALA [^2]. 

[^2]: Check out [this post](https://labs.ala.org.au/posts/2023-12-18_beginners-guide-make-a-map/#make-a-map-1) for a better explanation of what CRS is and how it affects maps.

```{r}
lga <- lga |>
  st_transform(crs = 4326)
```

Next we'll filter our shapefile to Yass Valley. The column `LGA_NAME23` contains area names, and we can filter our data frame to only rows where `LGA_NAME23` is equal to `Yass Valley`. We are left with a single polygon shape of Yass Valley.

```{r}
yass_valley <- lga |>
  filter(LGA_NAME23 == "Yass Valley")

yass_valley
```

### Download data

Now that `yass_valley` contains our LGA shape, we can build our query. Once again, we'll begin with `galah_call()` and filter to only records from 2024. We can specify that we want records within our `yass_valley` shapefile with `galah_geolocate()`. We then specify we wish to return a species list by ending our query with `atlas_species()`.

```{r}
species_yass <- galah_call() |>
  filter(year == 2024) |>
  galah_geolocate(yass_valley) |>
  atlas_species()

species_yass
```

It's also possible to group by `scientificName` (genus + species name) and return the observations counts by ending our query with `atlas_counts()`.

```{r}
species_counts <- galah_call() |>
  filter(year == 2024) |>
  galah_geolocate(yass_valley) |>
  group_by(scientificName) |>
  atlas_counts()

species_counts
```

:::


# Cross-reference with threatened and sensitive species lists

Next we'll compare our Yass valley species list with several state-wide conservation status lists of threatened and sensitive species. We can retrieve lists of threatened and sensitive species in one of two ways: <br>

  - Use lists available in the Atlas of Living Australia<br>
  - Use your own list

Both use the same method of matching species names in our Yass Valley list to species names in official conservation status lists. However, there's a slightly different workflow between using galah and using an externally downloaded list. Choose from the options below to use either method.

::: {.panel-tabset .nav-pills}

# Using lists in the ALA

We can use galah to access lists that are available on the Atlas of Living Australia. Yass Valley is within the state of New South Wales, so let's search for "New South Wales" to see what state-specific lists are available.

```{r}
search_all(lists, "New South Wales")
```

Two lists are returned, and both appear relevant. With the help of some additional columns returned by `search_all()`—`listType`, `isAuthoritative` and `isThreatened`—we can learn more about which list suits our needs best. Although both lists are authoritative, only one list (`dr650`) contains threatened species whereas the other (`dr487`) contains sensitive species. 

```{r}
search_all(lists, "New South Wales") |>
  select(species_list_uid, listType, isAuthoritative, isThreatened)
```

Let's filter to only return species on the New South Wales Conservation Status List (`dr650`) by adding `species_list_uid == dr650` to our filter.

```{r}
yass_threatened <- galah_call() |>
  galah_filter(species_list_uid == dr650,
               year == 2024) |>
  galah_geolocate(yass_valley) |>
  atlas_species()

yass_threatened
```

We can do the same using the New South Wales Sensitive Species (`dr487`).

```{r}
yass_sensitive <- galah_call() |>
  galah_filter(species_list_uid == dr487,
               year == 2024) |>
  galah_geolocate(yass_valley) |>
  atlas_species()

yass_sensitive
```

To return the record counts of each species, we can group by `scientificName` and end our query with `atlas_counts()`

```{r}
yass_sensitive_counts <- galah_call() |>
  galah_filter(species_list_uid == dr487,
               year == 2024) |>
  galah_geolocate(yass_valley) |>
  galah_group_by(scientificName) |>
  atlas_counts()

yass_sensitive_counts
```


# Using external lists

We can use our own conservation status lists from an external source to compare to our Yass Valley species list. As an example, we are using the the New South Wales Conservation Status List and the New South Wales Sensitive Species List[^3].

{{< downloadthis ../data/example_TSL.csv label="Download Conservation Status List" icon=database-fill-down type=info class=data-button >}} {{< downloadthis ../data/example_SSL.csv label="Download Sensitive Species List" icon=database-fill-down type=info class=data-button >}}

[^3]: These are the same two lists that you can access in galah, available from the Atlas of Living Australia. Keep in mind that if you use an external list, data cleaning may be required before matching species names.

First, let's read in both lists and see what each list looks like.

```{r}
#| eval: false
threatened_list <- read_csv(here("path", "to", "example_TSL.csv"))
sensitive_list <- read_csv(here("path", "to", "example_SSL.csv"))
```

```{r}
#| echo: false
#| warning: false
#| message: false
threatened_list <- read_csv(here("posts", "data", "example_TSL.csv"))
sensitive_list <- read_csv(here("posts", "data", "example_SSL.csv"))
```


Let's filter our Yass Valley species to only those on our `threatened_list`.

```{r}
yass_threatened <- species_yass |>
  filter(species_name %in% yass_threatened$species_name)

yass_threatened
```

We can do the same with our `sensitive_list`.

```{r}
yass_sensitive <- species_yass |>
  filter(species_name %in% yass_sensitive$species_name)

yass_sensitive
```

:::

## Add status information to a list with galah

As of galah version 2.1.2, we can also use `show_values()` to add conservation status columns to our species list. By adding the argument `all_fields = TRUE`, we can add any columns stored in the ALA from the original list. For conservation lists like the New South Wales Conservation Status List, this includes columns like `status`, `sourceStatus` and `IUCN_Status`.

```{r}
#| message: false
#| warning: false
list_with_status <- search_all(lists, "dr650") |>
  show_values(all_fields = TRUE)

list_with_status |>
  # reposition cols
  select(status, sourceStatus, IUCN_equivalent_status, 
         scientificName, everything()) 
```

This can be handy if we want to join this with other information like record counts.

```{r}
# get record counts for each species on the NSW Conservation Status list
yass_counts <- galah_call() |>
  galah_filter(species_list_uid == dr650,
               cl11170 == "Yass Valley",
               year == 2024) |>
  galah_group_by(scientificName) |>
  atlas_counts()

yass_counts

# join status information to counts
yass_counts |>
  left_join(list_with_status |> 
              select(status, scientificName), # choose columns
            join_by(scientificName == scientificName))
```



# Visualise species conservation status

A useful way to visualise the number of threatened and sensitive species in an area is with a waffle chart. Waffle charts are great because they display the total number of species (represented as individual square units) and proportions of different groups (represented by colours). 

For example, we can visualse the number and proportion of species with different conservation status, along with a taxonomic breakdown of threatened/sensitive species.

```{r}
#| code-fold: true
#| warning: false
#| message: false
library(waffle)
library(showtext)
library(glue)
library(marquee)

# Add conservation status & taxa groups for plotting
species_yass_grouped <- species_yass |>
  mutate(
    conservation_status = case_when(
      species_name %in% yass_sensitive$species_name ~ "Sensitive",
      species_name %in% yass_threatened$species_name ~ "Threatened",
      .default = "No status"
    ),
    taxa_group = case_when(
      class == "Aves" ~ "Birds",
      class == "Reptilia" ~ "Reptiles",
      class == "Mammalia" ~ "Mammals",
      kingdom == "Plantae" ~ "Plants",
      .default = "Other"
    )
  )

# Count number of species by conservation status
status_table <- species_yass_grouped |>
  group_by(conservation_status) |>
  summarise(n = n()) |>
  mutate(proportion = n/sum(n)|> round(2))

# Count number of species by taxonomic group
taxa_table <- species_yass_grouped |>
  filter(conservation_status %in% c("Sensitive", "Threatened")) |>
  group_by(taxa_group) |>
  summarise(n = n()) |>
  mutate(proportion = n/sum(n)*100)

# Extract percentage that are threatened/sensitive species
prop_threatened_or_sensitive <- status_table |>
  filter(conservation_status %in% c("Sensitive", "Threatened")) |>
  summarise(total = sum(proportion)) |>
  pull(total) |>
  round(2)

# Add nicer font
font_add_google("Roboto", "roboto")
showtext_auto()

# Plot 1 Waffle: Conservation Status
title <- marquee_glue(
"Of {sum(status_table$n) |> scales::comma()} species in Yass Valley, <br>
{status_table$proportion[3] |> scales::percent(.1)} are {#AB423F **threatened**}, \\
{status_table$proportion[2] |> scales::percent(.1)} are {#D89A98 **sensitive**}, and <br>
{status_table$proportion[1] |> scales::percent(.1)} have {#E0BEA4 **no status**}"
)

legend_order <- c("Threatened", "Sensitive", "No status")

waffle_status <- 
  ggplot() +
  waffle::geom_waffle(data = status_table |>
                        # reorder for better plotting
                        mutate(
                          conservation_status = forcats::fct_relevel(
                            conservation_status, legend_order
                            )) |>
                        arrange(match(conservation_status, legend_order)),
                      aes(fill = conservation_status,
                          values = n/2),
                      colour = "white",
                      n_rows = 15,
                      size = 1) +
  scale_fill_manual(name = "Conservation\nStatus",
                    values = c("#AB423F", "#D89A98", "#F3E6DC"),
                    labels = c("No status", "Sensitive", "Threatened")) +
  labs(title = title,
       caption = marquee_glue("1 {cli::symbol$square_small_filled} = 2 species")) +
  coord_equal() + 
  theme_void() + 
  theme(legend.position = "none",
        text = element_text(family = "roboto", lineheight = 0.5),
        plot.title = element_marquee(hjust = 0.5, size = 14, family = "roboto"),
        plot.caption = element_marquee(size = 12),
        plot.margin = margin(0, 1, 0, 1, unit = "cm"))

# Plot 2: Taxonomic breakdown
waffle_taxa <- 
  ggplot(taxa_table) +
  waffle::geom_waffle(aes(fill = taxa_group,
                          values = n),
                      colour = "white",
                      n_rows = 4,
                      size = 1) +
  scale_fill_manual(name = "Group",
                    values = c("#567C7C", "#6D714A", "#465743", "#22352C", "#C4AC79"),
                    labels = c("Birds", "Mammals", "Other", "Plants", "Reptiles")) +
  labs(title = marquee_glue("Taxonomic breakdown of threatened & sensitive species"),
       caption = marquee_glue("1 {cli::symbol$square_small_filled} = 1 species")) +
  coord_equal() + 
  theme_void() + 
  theme(legend.position = "bottom",
        text = element_text(family = "roboto"),
        legend.title = element_text(hjust = 0.5, size = 20),
        legend.text = element_text(size = 18),
        plot.title = element_marquee(hjust = 0.5, size = 14, margin = margin(b=5), family = "roboto"),
        plot.caption = element_marquee(size = 12, hjust = 1),
        plot.margin = margin(0.5, 1, 0.5, 1, unit = "cm"))
```


```{r}
#| echo: false
#| warning: false
#| message: false
#| column: page
#| fig-align: center
#| fig-width: 10
#| out-extra: "style=margin-left:auto;margin-right:auto;"
waffle_status
```

```{r}
#| echo: false
#| warning: false
#| message: false
waffle_taxa
```


# Final thoughts

We hope this post has helped you understand how to download a species list for a specific area and compare it to conservation lists. It's also possible to compare species with other information like lists of migratory species or seasonal species.

For other posts, check out [our beginner's guide to map species observations](https://labs.ala.org.au/posts/2023-12-18_beginners-guide-make-a-map/) or see [an investigation of dingo observations in the ALA](https://labs.ala.org.au/posts/2023-05-16_dingoes/).

<details>

<summary style="color: #E06E53;">

Expand for session info

</summary>

```{r, echo = FALSE}
library(sessioninfo)
# save the session info as an object
pkg_sesh <- session_info(pkgs = "attached")
# print it out
pkg_sesh
```

</details>




<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jarod Wright">
<meta name="author" content="Dax Kellie">
<meta name="dcterms.date" content="2025-02-10">
<meta name="description" content="We will use Species Distribution Modelling to assess the impact that the Black Summer bushfires had on the Southern Greater Glider’s habitat suitability.">

<title>Modelling the Impact of the Black Summer (2019/20) Bush Fires on the Southern Greater Glider (Petauroides volans) Distribution in Southern NSW</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>

      .quarto-title-block .quarto-title-banner {
        background: #B8573E;
      }
</style>
<meta name="quarto:status" content="draft">


</head>

<body><div id="quarto-draft-alert" class="alert alert-warning"><i class="bi bi-pencil-square"></i>Draft</div>

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Modelling the Impact of the Black Summer (2019/20) Bush Fires on the Southern Greater Glider (Petauroides volans) Distribution in Southern NSW</h1>
                  <div>
        <div class="description">
          <p>We will use Species Distribution Modelling to assess the impact that the Black Summer bushfires had on the Southern Greater Glider’s habitat suitability.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Eukaryota</div>
                <div class="quarto-category">Animalia</div>
                <div class="quarto-category">Gliders</div>
                <div class="quarto-category">Bush Fires</div>
                <div class="quarto-category">Maps</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Authors</div>
      <div class="quarto-title-meta-contents">
               <p>Jarod Wright </p>
               <p>Dax Kellie </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 10, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<!-- remove metadata section -->
<style>
  #title-block-header.quarto-title-block.default .quarto-title-meta {
      display: none;
  }
</style>
<!-- Author card -->
<div class="author-card page-columns page-full">
<div class="author-card-text">
<section id="author" class="level4">
<h4 class="anchored" data-anchor-id="author">Author</h4>
<p>Jarod Wright<br>
<a href="https://labs.ala.org.au/about/Kellie_Dax/index.html">Dax Kellie</a></p>
</section>
<section id="date" class="level4">
<h4 class="anchored" data-anchor-id="date">Date</h4>
<p>11 February 2025</p>
</section>
</div>
<div class="row-b page-columns page-full" data-layout-ncol="3" style="margin-left: auto; margin-right: auto; margin-top: auto; margin-bottom: auto;">
<div class="author-card-image" style="width: auto; height: 120px; margin-right: auto !important;">
<p><img src="https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/jarod.jpg" style="object-fit: cover; border-radius: 50% !important; width: 140px;"></p>
</div>
<div class="author-card-image" style="width: auto; height: 120px; margin-right: auto;">
<p><img src="https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/dax.jpg" style="object-fit: cover; border-radius: 50% !important; width: 140px;"></p>
</div>
<!------------------------ Post starts here ------------------------>
<p>Bushfires are a frequent and natural aspect of Australia’s ecosystems. Our flora and fauna have evolved along side fire, some plants even require fire to germinate and regenerate <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>Aboriginal and Torres Strait Islander people have expertly used fire for tens of thousands of years to care for Country, managing vegetation, reducing wildfire risk, and fostering biodiversity<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> This deep connection between fire and the environment continues to influence modern land management practices today. The disruption of these practices since colonisation have increased the risk of out of control bushfires due to the build up of fuel loads, and introduction of invasive plants.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>In 2019-2020 we experienced one of the most catastrophic bushfire seasons on record in Australia, with approximately 19 million hectares burnt and approximatelly 3 billion animals killed or displaced by the fires.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> Over 900 species of plant and animals were severely impacted by the fires<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>. Of the 19 million hectares burnt in those fires, 12.6 million were primarily forest and bushland.</p>
<p>In this post we will explore the impact of the 2019-2020 bushfires on a population of Greater gliders (<em>Petauroides volans</em>), an arboreal, marsupial species found all along the east coast from Australia, from Southern Queensland all the way down into Victoria. They inhabit tall, hollow bearing trees in eucalypt forests. Unfortunately they are increasingly under threat due to habitat destruction, climate change and intense bushfires. To investigate the impact the 2019/20 Bushfires had on Glider distribution in south-est NSW, we will use a species distribution model (SDM) to investigate what impact, if any, they had on the Gliders. We will then use a general linear model to statistically test whether there is a difference in greater glider observations before vs after the 2019-2020 bushfires.</p>
<section id="background" class="level1 page-columns page-full">
<h1>Background</h1>
<p>The Southern Greater Glider (<em>Petauroides volans</em>) is Australia’s largest gliding marsupial, found in tall eucalypt forests along the east coast, from Queensland to Victoria. They are an endagered nocturnal, tree-dwelling herbivore that primarily feed on eucalyptus leaves, much like the Koala! They grow up to 1m long from head to tail and glide up to 100 metres through the canopy. Gliders den in hollow bearing trees and can have multiple dens in their home range.</p>
<div>

</div>
<div class="quarto-layout-panel" style="margin-left: auto; margin-right: auto;" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><img src="https://ala-images.s3.ap-southeast-2.amazonaws.com/store/2/1/0/8/e0bec186-b95a-4a50-8ce3-824143268012/original" class="rounded"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><img src="https://ala-images.s3.ap-southeast-2.amazonaws.com/store/c/4/c/e/a0428bcf-f667-4f43-80b5-5ba1dc40ec4c/original" class="rounded"></p>
</div>
</div>
</div>
<div class="figure-caption">
<p>Left: <a href="https://biocache.ala.org.au/occurrences/fde509c4-f493-46fc-9ae5-bab9fe2fc621"><em>Petauroides volans</em> ( Josh Bowell | CC-BY-NC 3.0 (Au))</a>, Right: <a href="https://biocache.ala.org.au/occurrences/65b74308-6e20-40f1-ac34-0b8f65a468bd"><em>Petauroides volans</em> (David Sinnott | CC-BY-NC 4.0 (Int))</a></p>
</div>
<p>To begin, we can load some packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(galah)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels) </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidysdm) <span class="co"># devtools::install_github("EvolEcolGroup/tidysdm")</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyterra)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ozmaps)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(elevatr)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geodata)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stacks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="downloading-greater-glider-data" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="downloading-greater-glider-data">Downloading Greater Glider Data</h3>
<p>We’re going to be focusing on a region of South-East NSW. Let’s establish a bounding box around our area and pull in a map of Australia for later rendering and working with our rasters.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div></div><p>Now lets download Greater Glider records in a 10-year time period (2014-2024) which captures observations of greater gliders before and after the 2019-2020 bushfires.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">galah_config</span>(<span class="at">email =</span> <span class="st">"your-email-here"</span>) <span class="co"># Registered ALA email</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect all greater glider records between 2014 and 2024 for the region we defined</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>gliders <span class="ot">&lt;-</span> <span class="fu">galah_call</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">identify</span>(<span class="st">"Petauroides volans"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2014</span> <span class="sc">&amp;</span> year <span class="sc">&lt;=</span> <span class="dv">2024</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_apply_profile</span>(ALA) <span class="sc">|&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_geolocate</span>(se_nsw_bbox, <span class="at">type =</span> <span class="st">"bbox"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">atlas_occurrences</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will also add a new column in that will allow us to to see if a Glider record was seen before or after the fires.</p>
<p>The 1st of December 2019 has been selected as the cut-off as it marks the beginning of the peak of the bushfire season, by this point the worst of the bushfires were underway and we can consider all observations taken after that point to be “post-fire” as there would have been very few observations being done during this period because of the fires.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Classify each glider record as pre or post fire</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>gliders <span class="ot">&lt;-</span> gliders <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fire_period =</span> <span class="fu">if_else</span>(eventDate <span class="sc">&lt;</span> <span class="fu">as.Date</span>(<span class="st">"2019-12-01"</span>), <span class="st">"pre_fire"</span>, <span class="st">"post_fire"</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an sf object so we can draw it later</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>gliders_sf <span class="ot">&lt;-</span> gliders <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div></div><p>Now we’ve got a nice dataset of Greater Glider observations over a period of time in the area we’re interested with, classified by pre or post fire. Now, we’ll start pulling in our raster data to help build up our model.</p>
</section>
</section>
<section id="preparing-our-rasters" class="level1 page-columns page-full">
<h1>Preparing our rasters</h1>
<p>This post will make heavy use of raster files<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<p>We’ll be downloading several raster layers in order to create a robust model for Greater Gliders. Greater glider distribution is largely determined by availability of suitable habitat (tree cover and hollow bearing trees), elevation and climate data (precipitation and temperature). We will be downloading layers to supply each of these to the model to develop a reasonable prediction surface of Glider habitat. From this we will be able to reasonably investigate the impact that the bushfires had on predicted glider presence.</p>
<p>We will be downloading <a href="https://glad.umd.edu/dataset/global-2010-tree-cover-30-m">tree cover layers</a>, <a href="https://github.com/USEPA/elevatr">elevation layers</a>, <a href="https://chelsa-climate.org/">climate layers</a> and <a href="https://datasets.seed.nsw.gov.au/dataset/fire-extent-and-severity-mapping-fesm-2019-20">fire extent layers</a>.</p>
<section id="raster-preparation-steps" class="level3">
<h3 class="anchored" data-anchor-id="raster-preparation-steps">Raster Preparation steps</h3>
<p>For each raster, we will perform a common series of modifications; cropping them to our region of interest, making sure they are all in the same projection and then resampling to make them have the same resolution.</p>
<p>This process is slightly repetitive, but when working with spatial data for modelling, it is critical that rasters are in the same dimensions, resolution and projection. Otherwise, the raster pixels won’t align with each other!</p>
<p>Because of the repetitive nature I won’t be detailing the exact steps for each raster (except where they deviate) and will instead lay out the common steps here:</p>
<ul>
<li>Rename the layers to something more sensible</li>
<li>Crop them to match our region</li>
<li>Mask out the ocean so that it does not skew our model</li>
<li>Resample each layer to have matching resolutions</li>
</ul>
</section>
<section id="download-elevation-raster" class="level3">
<h3 class="anchored" data-anchor-id="download-elevation-raster">Download Elevation Raster</h3>
<p>The first raster we’ll be grabbing is an elevation raster for our defined region, fortunately for us the <code>{elevatr}</code> package provides us with the handy <code>get_elev_raster()</code> function. When we call it we pass in our bounding box from earlier and get elevation data (in metres) back for our region!</p>
<p>Since we’ll be using multiple rasters in this post, we need to establish a “main” raster: one that defines our coordinate reference system (CRS) and resolution. The elevation raster has the coarsest resolution, so we’ll use it as our reference for aligning all other rasters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the elevation raster</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>elevation_data <span class="ot">&lt;-</span> <span class="fu">get_elev_raster</span>(<span class="at">locations =</span> bbox_sf, <span class="at">z =</span> <span class="dv">9</span>, <span class="at">prj =</span> <span class="st">"EPSG:4326"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Masking allows us to remove raster information we aren't interested in using</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># the mask function. For our model we will use the land boundaries of Australia</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>elevation_aligned <span class="ot">&lt;-</span> elevation_data <span class="sc">|&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(aus)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># elevation_aligned is now a RasterLayer, so lets turn it back into a SpatRaster</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>elevation_aligned <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(elevation_aligned)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure that it's in our desired projection</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>elevation_aligned <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(elevation_aligned, <span class="st">"EPSG:4326"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop it down to our bounding box</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>elevation_aligned <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(elevation_aligned, bbox_ext)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># This column is different everytime, but it's always of the format file&lt;UID&gt;</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># So we'll just rename it to elevation for simplicities sake</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>colname <span class="ot">&lt;-</span> <span class="fu">names</span>(elevation_aligned)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(elevation_aligned) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(elevation_aligned), </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                                            colname, </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"elevation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-tree-cover-data" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="download-tree-cover-data">Download Tree Cover Data</h3>
<p>Next we’ll be downloading our tree cover data. This dataset is in the form of a percentage (0 = no cover, 100 = complete tree cover). Because our data set crosses over two regions, we will be stitching together two rasters that cover central NSW to the east coast, and we will then crop them down to our area of focus.</p>
<p>This tree cover data is satellite data from 2010 by Hansen et al, full details can be found <a href="https://glad.umd.edu/dataset/global-2010-tree-cover-30-m">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://glad.umd.edu/Potapov/TCC_2010/treecover2010_30S_140E.tif"</span>, <span class="at">destfile=</span><span class="st">"treecover2010_30S_140E.tif"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://glad.umd.edu/Potapov/TCC_2010/treecover2010_30S_150E.tif"</span>, <span class="at">destfile=</span><span class="st">"treecover2010_30S_150E.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have the files, let’s perform our common steps for tidying up the rasters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raster</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>tree_cover_rast_150e_2010 <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"treecover2010_30S_150E.tif"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the names of the layers in the raster</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree_cover_rast_150e_2010)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># In this case we have one layer, and it's titled "Layer_1", which is not very helpful. So we'll change that to a more suitable name</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree_cover_rast_150e_2010) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(tree_cover_rast_150e_2010), </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                                                    <span class="st">"Layer_1"</span>, </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                                                    <span class="st">"treecover"</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># See the change has worked</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree_cover_rast_150e_2010)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's repeat the process for the 140E raster</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>tree_cover_rast_140e_2010 <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"treecover2010_30S_140E.tif"</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree_cover_rast_140e_2010)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree_cover_rast_140e_2010) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(tree_cover_rast_140e_2010), </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>                                                    <span class="st">"Layer_1"</span>, </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                                                    <span class="st">"treecover"</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree_cover_rast_140e_2010)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop our raster files to our bounding box extent</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>tree_cover_rast_150e_2010 <span class="ot">&lt;-</span> tree_cover_rast_150e_2010 <span class="sc">|&gt;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(bbox_ext)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>tree_cover_rast_140e_2010 <span class="ot">&lt;-</span> tree_cover_rast_140e_2010 <span class="sc">|&gt;</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(bbox_ext)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the two rasters into a single raster</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>tree_cover_2010 <span class="ot">&lt;-</span> <span class="fu">merge</span>(tree_cover_rast_140e_2010, tree_cover_rast_150e_2010)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Resample our tree cover to the resolution of the elevation data</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>tree_cover_2010 <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(tree_cover_2010, elevation_aligned)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Best practice: When working with spatial data we tend to use up a lot of memory! That’s a big reason why we are performing these cropping steps, so that we can use up the least amount of memory necessary to get our model to function. Because of this, after we have stitched our two rasters into our composite <code>tree_cover_2010</code> raster, we can safely delete the other two as we will no longer require them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can now safely delete the first two raster files to save memory</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(tree_cover_rast_140e_2010)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(tree_cover_rast_150e_2010)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div></div></section>
<section id="download-climate-rasters" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="download-climate-rasters">Download Climate Rasters</h3>
<p>We’ll be using climate projections from CHELSA, specifically the UKESM1-0-LL SSP3-7.9 model for 2011-2040. This dataset provides bioclimatic variables at a reasonable resolution, making it a great choice for our analysis.</p>
<p>We’ll be focusing on two key variables:</p>
<ul>
<li>Bio1: Mean Annual Temperature</li>
<li>Bio12: Annual Precipitation</li>
</ul>
<p>Greater gliders are sensitive to temperature and precipitation changes, and so these two variables are a sensible set to incorporate into our model to help understand their range.</p>
<p>Let’s download and load the two raster files, and perform our clean up steps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download our two raster files</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://os.zhdk.cloud.switch.ch/chelsav2/GLOBAL/climatologies/2011-2040/UKESM1-0-LL/ssp370/bio/CHELSA_bio1_2011-2040_ukesm1-0-ll_ssp370_V.2.1.tif"</span>,              <span class="at">destfile=</span><span class="st">"CHELSA_bio1_2011-2040_ukesm1-0-ll_ssp370_V.2.1.tif"</span>, <span class="at">mode=</span><span class="st">"wb"</span>)  </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://os.zhdk.cloud.switch.ch/chelsav2/GLOBAL/climatologies/2011-2040/UKESM1-0-LL/ssp370/bio/CHELSA_bio12_2011-2040_ukesm1-0-ll_ssp370_V.2.1.tif"</span>,               <span class="at">destfile=</span><span class="st">"CHELSA_bio12_2011-2040_ukesm1-0-ll_ssp370_V.2.1.tif"</span>, <span class="at">mode=</span><span class="st">"wb"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bio1 <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"CHELSA_bio1_2011-2040_ukesm1-0-ll_ssp370_V.2.1.tif"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>bio12 <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"CHELSA_bio12_2011-2040_ukesm1-0-ll_ssp370_V.2.1.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop to our bounding box extent</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>bio1 <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(bio1, bbox_ext)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Mask out the oceans</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>bio1 <span class="ot">&lt;-</span> <span class="fu">mask</span>(bio1, aus)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the name, and replace the horrible large name with something short and sweet</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(bio1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "bio1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(bio1) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(bio1),</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"CHELSA_bio1_2011-2040_ukesm1-0-ll_ssp370_V.2.1"</span>, </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"bio1"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Resample our bioclim variable to the resolution of the elevation raster</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>bio1 <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(bio1, elevation_aligned)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeat for our BIO12 raster</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>bio12 <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(bio12, bbox_ext)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>bio12 <span class="ot">&lt;-</span> <span class="fu">mask</span>(bio12, aus)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(bio12)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "bio12"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(bio12) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(bio12),  </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"CHELSA_bio12_2011-2040_ukesm1-0-ll_ssp370_V.2.1"</span>, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"bio12"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>bio12 <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(bio12, elevation_aligned)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div></div><p>Now our climate rasters are ready to use, and we only need to incorporate the fire extent raster.</p>
</section>
<section id="download-our-fire-extent-raster" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="download-our-fire-extent-raster">Download our Fire Extent Raster</h3>
<section id="prepare-fire-extent-raster" class="level4">
<h4 class="anchored" data-anchor-id="prepare-fire-extent-raster">Prepare Fire Extent Raster</h4>
<p>To assess the impact of the 2019-2020 Black Summer Bushfires, we need a raster that maps burnt areas across NSW for that period. The NSW Government’s Fire Extent and Severity Mapping (FESM) dataset provides this information, detailing the extent and severity of burnt areas across the state.</p>
<p>The dataset is available here: <a href="https://datasets.seed.nsw.gov.au/dataset/fire-extent-and-severity-mapping-fesm-2019-20">Fire Extent and Severity Mapping (FESM) 2019/20</a>.</p>
<p>We will download the FESM v3-data in IMG and TIFF format, then extract the .tif file to our working directory.</p>
<p><strong>Note</strong>: While the download itself is only several hundred megabytes, uncompressed the .tif file is very large (10.3 GB) so please keep this in mind before downloading!</p>
</section>
<section id="processing-the-fire-raster" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="processing-the-fire-raster">Processing the fire raster</h4>
<p>To save processing time and memory, we will be cropping this large raster down to just our desired range. Unlike our previous rasters, this dataset is NOT in WGS84 and so we will need to transform it a little differently to our previous rasters:</p>
<ol type="1">
<li>Create a SpatExtent that matches our study area</li>
<li>Reproject that extent to the projection of our fire map.</li>
<li>Create a bounding box of that extent in that projection.</li>
<li>Crop our fire extent raster in that projection.</li>
<li>Reproject the now cropped fire extent raster to the WGS84.</li>
</ol>
<p>These steps allow us to skip a lot of the processing time needed to reproject the <em>entire</em> raster into WGS84 and then cropping down, instead cropping and then reprojecting.</p>
<details>
<summary>
What each value means in the fire extent raster
</summary>
<p>The dataset categorises fire severity using the following range of values:</p>
<ul>
<li>0 - unburnt (0% canopy and understory burnt)</li>
<li>1 - Reserved (Experimental category, is not used in raster right now)</li>
<li>2 - Low (&gt; 10% burnt upderstory, &gt;90% green canopy)</li>
<li>3 - Moderate (20-90% canopy scorch)</li>
<li>4 - High (&gt; 90% canopy scorched, &lt;50% canopy consumed)</li>
<li>5 - Extreme (&gt;50% canopy biomass consumed)</li>
</ul>
</details>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Load the raster</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>fire_extent <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"cvmsre_NSW_20192020_ag1l0.tif"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We are going to make our extent a polygon polygon first</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>bbox_ext_vect <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">as.polygons</span>(bbox_ext, <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject the bounding box to the same projection of fire_extent</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>bbox_ext_vect_proj <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(bbox_ext_vect, <span class="fu">crs</span>(fire_extent))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an extent of that bbox projection</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>bbox_ext_proj <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(bbox_ext_vect_proj)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  Crop fire_extent using the reprojected bbox</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>fire_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(fire_extent, bbox_ext_proj)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject our fire extent to WGS84</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>fire_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(fire_extent, <span class="st">"EPSG:4326"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Then crop again to align it with our other raster files</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>fire_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(fire_extent, bbox_ext)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we’ve reduced this very large raster down, all we need to do is rename the layer, resample to our desired resolution and then mask out the oceans.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(fire_extent) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(fire_extent), </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"Layer_1"</span>, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"fire_extent"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Resample and round</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>fire_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(fire_extent, elevation_aligned)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>fire_extent <span class="ot">&lt;-</span> <span class="fu">round</span>(fire_extent)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Mask out the ocean</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>fire_extent <span class="ot">&lt;-</span> fire_extent <span class="sc">|&gt;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">mask</span>(aus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div></div><p>Finally, we will add a new column to our Greater Glider observation dataset, in which we will record the fire severity category at each glider’s recorded location.</p>
<p>To achieve this, we will extract the fire severity values from the processed fire extent raster at the coordinates where Greater Gliders were observed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>gliders_sf<span class="sc">$</span>burnt <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(fire_extent, <span class="fu">vect</span>(gliders_sf), <span class="at">ID =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have all our rasters ready to go, we can begin the modelling process!</p>
</section>
</section>
</section>
<section id="building-our-model" class="level1">
<h1>Building our model</h1>
<p>If you’re new to species distribution modeling (SDM) or want a deeper dive into the details, I highly recommend checking out this other fantastic ALA labs post that dives into the nitty gritty for each step: <a href="https://labs.ala.org.au/posts/2024-04-30_sdm-tidymodels/">An introduction to species distribution modelling using {tidysdm} &amp; {tidymodels}</a>. This post is focused more with working with rasters, applying them to use in an SDM and exploring the output of the model statistically.</p>
<section id="combining-our-rasters" class="level3">
<h3 class="anchored" data-anchor-id="combining-our-rasters">Combining our rasters</h3>
<p>To begin we need to combine all the raster datasets we’ve prepared so far. This will allow our model to extract environmental values at each Glider occurrence (or absence).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>combined_rasters <span class="ot">&lt;-</span> <span class="fu">c</span>(elevation_aligned, bio1, bio12, fire_extent, tree_cover_2010)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have a single raster with multiple layers detailing:</p>
<ul>
<li>Elevation</li>
<li>Mean annual temperature (BIO1)</li>
<li>Annual precipitation (BIO12)</li>
<li>Extent of the 2019 bushfires</li>
<li>Tree cover</li>
</ul>
</section>
<section id="thinning-our-data" class="level3">
<h3 class="anchored" data-anchor-id="thinning-our-data">Thinning our data</h3>
<p>Since raster cells have a fixed resolution, we want to avoid multiple glider observations within a single cell (because multiple observations below this level won’t matter anyway). We’ll use <code>{tidysdm}</code>’s <code>thin_by_cell()</code> function to make sure only one glider record exists per raster grid cell.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># see results of thinning</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>gliders_thin <span class="ot">&lt;-</span> tidysdm<span class="sc">::</span><span class="fu">thin_by_cell</span>(gliders_sf, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">raster =</span> combined_rasters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pseudo-absences-and-accurate-prepost-fire-columns" class="level3">
<h3 class="anchored" data-anchor-id="pseudo-absences-and-accurate-prepost-fire-columns">Pseudo-absences and Accurate Pre/Post-Fire Columns</h3>
<p>What we currently have is a list of actual observations. Unfortunately in SDM we don’t often have true absence data to work with, just records of actual observations. To work around this, we will generate a bunch of pseudo-absences based off our combined raster.</p>
<p>To accurately assess the impact of the 2019–2020 Black Summer Bushfires on Greater Glider presence using a GLM, we need both presence and absence data. However, we lack a raster dataset that explicitly distinguishes pre- and post-fire habitat suitability, which is used by the <code>sample_pseudoabs()</code> function to generate pseudo-absence locations.</p>
<p>To overcome this, we will randomly assign 50% of the pseudo-absence records to the pre-fire period and the other 50% to the post-fire period. This artificial split ensures that our model includes pseudo-absence data for both timeframes, allowing us to analyze changes in glider distribution before and after the fires.</p>
<p>Once the pseudo-absence records are generated, we will reassign the correct pre- and post-fire values to our actual presence observations in the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the pseudoabsence records</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>gliders_pseudoabs <span class="ot">&lt;-</span> tidysdm<span class="sc">::</span><span class="fu">sample_pseudoabs</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  gliders_thin,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">nrow</span>(combined_rasters), </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">raster =</span> combined_rasters,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"dist_min"</span>, <span class="fu">km2m</span>(<span class="dv">5</span>)))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of rows so we can generate random categories</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>n_pseudo <span class="ot">&lt;-</span> <span class="fu">nrow</span>(gliders_pseudoabs)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate random categories for our pseudoabsences</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>pseudo_categories <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"pre_fire"</span>, <span class="st">"post_fire"</span>), <span class="at">size =</span> n_pseudo, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the real categories from our original data</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>real_categories <span class="ot">&lt;-</span> gliders_thin <span class="sc">|&gt;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(fire_period) <span class="sc">|&gt;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="st">"presence"</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Put the pseudo categories into our pseudoabsences</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>gliders_pseudoabs <span class="ot">&lt;-</span> gliders_pseudoabs <span class="sc">|&gt;</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fire_period =</span> pseudo_categories)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the tree cover, elevation values and climate values at the pseudoabs points</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>gliders_events <span class="ot">&lt;-</span> gliders_pseudoabs <span class="sc">|&gt;</span> </span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">extract</span>(combined_rasters,</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                   gliders_pseudoabs,</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ID =</span> <span class="cn">FALSE</span>))</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Join the real fire_period category from the original records to overwrite our fake ones</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>gliders_events <span class="ot">&lt;-</span> gliders_events <span class="sc">|&gt;</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(real_categories <span class="sc">|&gt;</span> <span class="fu">select</span>(fire_period), <span class="at">left =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fire_period =</span> <span class="fu">coalesce</span>(fire_period.y, fire_period.x)) <span class="sc">|&gt;</span>  <span class="co"># Overwrite only if match found</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fire_period.x, <span class="sc">-</span>fire_period.y)  <span class="co"># Remove redundant columns</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove any NA records </span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>gliders_events <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(gliders_events)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s select our predictor variables to filter out all the unnecessary columns in our data frame. We will then turn our pre/post fire column into a numeric value for our modelling and statitical analysis later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select our predictor variables</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>predictor_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"elevation"</span>, <span class="st">"bio1"</span>, <span class="st">"bio12"</span>, <span class="st">"fire_extent"</span>, <span class="st">"treecover"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select all the columns we're interested in</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>gliders_filtered <span class="ot">&lt;-</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  gliders_events <span class="sc">|&gt;</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(predictor_vars, <span class="st">"class"</span>, <span class="st">"fire_period"</span>)))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Change fire period into a numeric value </span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>gliders_filtered <span class="ot">&lt;-</span> gliders_filtered <span class="sc">|&gt;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fire_period =</span> <span class="fu">if_else</span>(fire_period <span class="sc">==</span> <span class="st">"post_fire"</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>gliders_filtered<span class="sc">$</span>fire_period <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(gliders_filtered<span class="sc">$</span>fire_period)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tuning-and-running-the-model" class="level1">
<h1>Tuning and Running the Model</h1>
<p>Now that we’ve cleaned and prepared our data and generated our pseudoabsence data, we’re ready to start modelling!</p>
<p>Rather than using a single mdoel, we’ll be training multiple models, investigating their relative performance, and then combining them into an ensemble model that will help make our final prediction a bit more robust.</p>
<section id="training-and-testing" class="level3">
<h3 class="anchored" data-anchor-id="training-and-testing">Training and testing</h3>
<p>Firstly let’s split our glider presence/pseudoabsence data into training and testing datasets. This allows us to train the model on one subset of the data, while evaluating it’s performance on the other subset of the data. In order to improve our model and try and prevent overfitting, we’ll use spatial block cross-validation. Spatial block cross validation divides the study area into spatial blocks and ensures our model is tested on spatially independent data, making it’s predictions more general.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set training and testing data</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create training and testing datasets</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>gliders_split <span class="ot">&lt;-</span> </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  gliders_filtered <span class="sc">|&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>gliders_split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Training/Testing/Total&gt;
&lt;5886/1962/7848&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>gliders_train <span class="ot">&lt;-</span> <span class="fu">training</span>(gliders_split)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>gliders_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 5886 features and 7 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 148.5 ymin: -37.49949 xmax: 150.828 ymax: -35.00099
Geodetic CRS:  WGS 84
# A tibble: 5,886 × 8
   elevation  bio1 bio12 fire_extent treecover class     fire_period
       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;       &lt;int&gt;     &lt;dbl&gt; &lt;fct&gt;           &lt;dbl&gt;
 1       899 12.3   739.           0     0     pseudoabs           1
 2      1141 10.8   779.           0    86.9   presence            1
 3      1310  9.45  775.           2    69.2   pseudoabs          -1
 4       958 11.0   772.           0    23.2   pseudoabs          -1
 5      1008 11.7   705.           0     0.124 pseudoabs           1
 6       821 12.1   651.           0     0.234 pseudoabs           1
 7       930 11.8   616.           0     0     pseudoabs           1
 8       755 13.3   675.           0     0     pseudoabs          -1
 9       703 12.6   902.           0    88.1   pseudoabs          -1
10       909 11.5   856.           0    78.8   presence            1
# ℹ 5,876 more rows
# ℹ 1 more variable: geometry &lt;POINT [°]&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>gliders_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(gliders_split)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>gliders_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1962 features and 7 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 148.5 ymin: -37.49828 xmax: 150.8171 ymax: -35.00099
Geodetic CRS:  WGS 84
# A tibble: 1,962 × 8
   elevation  bio1 bio12 fire_extent treecover class    fire_period
       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;       &lt;int&gt;     &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt;
 1      1092  10.5  838.           0      76.7 presence           1
 2       937  10.9  947.           0      88.5 presence          -1
 3      1022  10.4  937.           0      90   presence          -1
 4      1000  10.4  926.           0      90   presence          -1
 5      1233  10.3  889.           0      76.5 presence          -1
 6        28  17.2  938.           4      64.9 presence          -1
 7      1075  11.0  866.           3      86.0 presence           1
 8       948  10.7 1023.           0      86.4 presence          -1
 9      1024  10.0 1108.           0      90   presence          -1
10      1090  11.0  792.           4      89.7 presence           1
# ℹ 1,952 more rows
# ℹ 1 more variable: geometry &lt;POINT [°]&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform Cross validation</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>gliders_cv <span class="ot">&lt;-</span> <span class="fu">spatial_block_cv</span>(gliders_train, <span class="at">v =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’re going to create a new recipe for our model, this will explain how our response variable <code>class</code> (presence or absence) is effected by each predictor variable (<code>elevation</code>, <code>bio1</code>, <code>bio12</code>, <code>treecover</code>, <code>fire_extent</code> and <code>fire_period</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>gliders_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  gliders_train, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> class <span class="sc">~</span> elevation <span class="sc">+</span> bio1 <span class="sc">+</span> bio12 <span class="sc">+</span> treecover <span class="sc">+</span> fire_extent <span class="sc">+</span> fire_period</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rather than relying on a single model, we’ll train up four and compare their performance. These models are:</p>
<ol type="1">
<li>Generalised Linear Model</li>
<li>Random Forest</li>
<li>Gradient Boosting Machine</li>
<li>Maximum entropy</li>
</ol>
<p>We will later build an ensemble of the best models</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>gliders_models <span class="ot">&lt;-</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_set</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">default =</span> gliders_recipe), <span class="co"># Use the same recipe for all</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> <span class="fu">list</span>(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">glm =</span> <span class="fu">sdm_spec_glm</span>(),        <span class="co"># Generalised Linear Model</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">rf =</span> <span class="fu">sdm_spec_rf</span>(),          <span class="co"># Random Forest</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">gbm =</span> <span class="fu">sdm_spec_boost_tree</span>(), <span class="co"># Gradient Boosting Machine</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxent =</span> <span class="fu">sdm_spec_maxent</span>()   <span class="co"># Maximum Entropy</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">cross =</span> <span class="cn">TRUE</span> </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">option_add</span>(<span class="at">control =</span> <span class="fu">control_ensemble_grid</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’ll tune our models using the cross validation blocks we generated earlier. This step helps us find the best model parameters by testing different variations and selecting the ones that perform best. This plot will give us a visualisation of the model performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">9999</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model using cross validation</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>gliders_models_tune <span class="ot">&lt;-</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  gliders_models <span class="sc">|&gt;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(<span class="st">"tune_grid"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">resamples =</span> gliders_cv,     <span class="co"># Use our cross-validation blocks for tuning</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">grid =</span> <span class="dv">6</span>,                   <span class="co"># number of tuning iterations</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">metrics =</span> <span class="fu">sdm_metric_set</span>(), <span class="co"># Evaluate model performance</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">control =</span> stacks<span class="sc">::</span><span class="fu">control_stack_grid</span>()</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(gliders_models_tune)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">98765</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because we are using a collection of models, we can use stacks to combine the best models into an ensemble model that will help improve accuracy and generalisation. We will see a plot at the end detailing how much each model is contributing to the ensemble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>gliders_stacked <span class="ot">&lt;-</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stacks</span>() <span class="sc">|&gt;</span>                                <span class="co"># initialize the model stack</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_candidates</span>(gliders_models_tune) <span class="sc">|&gt;</span> <span class="co">#  Add the tuned models</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blend_predictions</span>() <span class="sc">|&gt;</span>                     <span class="co"># Blend their predictions</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_members</span>()                              <span class="co"># Fit the final model</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualise each models contribution</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(gliders_stacked, <span class="at">type =</span> <span class="st">"weights"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now that we have our stacked ensemble model, it’s time to see how well it performs on unseen test data. This step helps us validate the model’s accuracy and assess how well it generalizes to new observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict probability of presence </span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>gliders_test_predictions <span class="ot">&lt;-</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  gliders_test <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(gliders_stacked, ., </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"prob"</span>, </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">save_pred =</span> <span class="cn">TRUE</span>))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate performance</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>gliders_test_predictions <span class="sc">|&gt;</span> </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sdm_metric_set</span>()(<span class="at">truth =</span> class, .pred_presence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  .metric    .estimator .estimate
  &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt;
1 boyce_cont binary         0.971
2 roc_auc    binary         0.966
3 tss_max    binary         0.814</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Give a final classification</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>gliders_test_predictions_class <span class="ot">&lt;-</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  gliders_test <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(gliders_stacked, ., </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"class"</span>, </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">save_pred =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="generating-the-final-raster" class="level1">
<h1>Generating the Final Raster</h1>
<p>Now we’ve got a trained and tested model, we can now <em>almost</em> finally make our predictions!</p>
<p>The last step we need to do is create a pseudo “fire-period” raster. We need this raster because our model only evaluates the impact of <code>fire_period</code> on the glider records, we didn’t have the need a raster of fire_period previously, however because we are producing a final raster, we <em>DO</em> need a raster that we can sample from in order to produce that prediction.</p>
<div class="cell" data-messages="false">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty raster with the same dimensions as our combined raster</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>presence_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(combined_rasters, <span class="at">nlyr =</span> <span class="dv">1</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(presence_raster) <span class="ot">&lt;-</span> <span class="cn">NA</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the layer for clarity</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(presence_raster) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(presence_raster), </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">"lyr1"</span>, </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">"fire_period"</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert glider observations into a vector to be sampled</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>gliders_vect <span class="ot">&lt;-</span> <span class="fu">vect</span>(gliders_filtered)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Rasterize the fire period from the glider points</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>fire_period_raster <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(gliders_vect, presence_raster, <span class="at">field =</span> <span class="st">"fire_period"</span>, <span class="at">fun =</span> <span class="st">"first"</span>)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(fire_period_raster) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(fire_period_raster), </span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"first"</span>, </span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"fire_period"</span>)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign pre/post values to the cells</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-fire</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>fire_period_raster[<span class="fu">is.na</span>(fire_period_raster) <span class="sc">&amp;</span> (fire_extent <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> fire_extent <span class="sc">==</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> </span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-fire</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>fire_period_raster[<span class="fu">is.na</span>(fire_period_raster) <span class="sc">&amp;</span> <span class="sc">!</span>(fire_extent <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> fire_extent <span class="sc">==</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Add this fire period raster into our raster stack</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>combined_rasters <span class="ot">&lt;-</span> <span class="fu">c</span>(combined_rasters, fire_period_raster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are finally ready to perform our final prediction!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform our final prediction!</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>prediction_present <span class="ot">&lt;-</span> <span class="fu">predict_raster</span>(gliders_stacked, </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                                     combined_rasters, </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">type =</span> <span class="st">"prob"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">wopt =</span> <span class="fu">list</span>(<span class="at">steps=</span><span class="dv">32</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="the-final-plot" class="level3">
<h3 class="anchored" data-anchor-id="the-final-plot">The final plot</h3>
<p>Now let’s plot it, and have a look at our map detailing habitat suitability for our gliders!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spatraster</span>(<span class="at">data =</span> prediction_present, </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">fill =</span> .pred_presence)) <span class="sc">+</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_whitebox_c</span>(<span class="at">palette =</span> <span class="st">"viridi"</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">na.value =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colorbar</span>(<span class="at">title=</span><span class="st">"Relative</span><span class="sc">\n</span><span class="st">Habitat</span><span class="sc">\n</span><span class="st">Suitability"</span>)) <span class="sc">+</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Predicted Suitable Habitat for Greater Gliders"</span>, <span class="at">subtitle =</span> <span class="st">"Elevation, tree cover, mean annual temp, annual precipitation and fire events."</span>) <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  pilot<span class="sc">::</span><span class="fu">theme_pilot</span>(<span class="at">grid=</span><span class="st">"hv"</span>) <span class="sc">+</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>&lt;SpatRaster&gt; resampled to 500556 cells.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="finishing-up-statistical-analysis" class="level1">
<h1>Finishing up: Statistical Analysis</h1>
<p>Now let’s investigate the relative effect that each variable had on the final prediction raster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join the prediction raster and our other rasters</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>final_raster <span class="ot">&lt;-</span> <span class="fu">c</span>(prediction_present, combined_rasters)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a GLM </span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>lm <span class="ot">&lt;-</span> <span class="fu">glm</span>(.pred_presence <span class="sc">~</span> elevation <span class="sc">+</span> bio1 <span class="sc">+</span> bio12 <span class="sc">+</span> fire_extent <span class="sc">+</span> treecover <span class="sc">+</span> fire_period, <span class="at">data =</span> final_raster)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = .pred_presence ~ elevation + bio1 + bio12 + fire_extent + 
    treecover + fire_period, data = final_raster)

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -1.421e+00  4.361e-03  -325.9   &lt;2e-16 ***
elevation    5.086e-04  1.366e-06   372.5   &lt;2e-16 ***
bio1         7.457e-02  2.440e-04   305.7   &lt;2e-16 ***
bio12        1.857e-04  9.228e-07   201.2   &lt;2e-16 ***
fire_extent -3.396e-02  1.892e-04  -179.5   &lt;2e-16 ***
treecover    3.174e-03  4.641e-06   683.9   &lt;2e-16 ***
fire_period  5.919e-02  3.777e-04   156.7   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 0.03670401)

    Null deviance: 145919  on 2825491  degrees of freedom
Residual deviance: 103707  on 2825485  degrees of freedom
  (1391370 observations deleted due to missingness)
AIC: -1319473

Number of Fisher Scoring iterations: 2</code></pre>
</div>
</div>
<section id="breaking-down-the-stats" class="level3">
<h3 class="anchored" data-anchor-id="breaking-down-the-stats">Breaking down the stats</h3>
<p>This output can be a bit confusing, so let’s look at the key takeaways:</p>
<p>The estimate tells us how much each variable increases or decreases the likelihood of finding a glider:</p>
<ul>
<li>Positive estimate: Higher values of this variable <strong>increase</strong> the likelihood of glider presence.</li>
<li>Negative estimate: Higher values of this variable <strong>decrease</strong> the likelihood of glider presence.</li>
<li>Larger absolute values mean a stronger influence.</li>
</ul>
<p>The effect size (t-value) tells us how strong each variable is on the final prediction. The absolute value of the effect size tells us it’s strength, and whether it’s positive or negative tells us whether or not it’s associated with increased glider predicition chance, or decreased glider prediction chance.</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>So what does our model actually say about Greater Glider distribution in South-East NSW?</p>
<ol type="1">
<li><p>Tree cover is critical - Tree cover is the strongest predictor of glider presence.</p></li>
<li><p>Elevation and temperature are big predictors - Greater Gliders appear to prefer higher elevations and (relative to the surrounds) warmer annual temperatures.</p></li>
<li><p>Rainfall plays a part - More precipitation increases the likelihood of glider presence, which is not a big surprise considering the relationship between precipitation and tree cover, and precipitation and elevation!</p></li>
</ol>
<p>But from our research we alraedy had some idea of these, so let’s look at the variables we’re actually interested in, fire!</p>
<p>Severe fires have a negative impact in glider distribution - The more extreme the fire events in the 2019 bushfire season, the less likely we were to see gliders present. Fires that are too intense can scorch and destroy the critical habitat needed by Greater Gliders</p>
<p>The pre vs post-fire effect is interesting. We saw a slight increase in post-fire glider presence in our model. This could be due to a number of factors, perhaps new tree hollows were formed in the fires, perhaps there increased survey efforts, or surviving gliders being more visible due to reduced canopy cover, or even just more data entering into the ALA</p>
<p>This model gives us a solid look at how Greater Gliders were affected by the 2019 fires. While fires can sometimes create tree hollows, our model suggests that severe fires disrupted habitat more than they helped. This kind of modeling is super useful for conservation planning, helping us predict which areas need protection or restoration.</p>
<section id="change-in-habitat-suitability-for-fire-affected-regions" class="level3">
<h3 class="anchored" data-anchor-id="change-in-habitat-suitability-for-fire-affected-regions">Change in habitat suitability for fire affected regions</h3>
<p>As a final extra, let’s create a map looking at the difference in habitat suitability for pre and post fire regions. To do this we will generate two separate models, those with data before and those with data after and subtract the two habitat suitability maps from each other to see what has changed due to fire!</p>
<details>
<summary style="color: #E06E53;">
<p>Expand for comparison map</p>
</summary>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect all greater glider records in that period</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>gliders_2019 <span class="ot">&lt;-</span> <span class="fu">galah_call</span>() <span class="sc">|&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">identify</span>(<span class="st">"Petauroides volans"</span>) <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2014</span> <span class="sc">&amp;</span> year <span class="sc">&lt;</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_apply_profile</span>(ALA) <span class="sc">|&gt;</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_geolocate</span>(se_nsw_bbox, <span class="at">type =</span> <span class="st">"bbox"</span>) <span class="sc">|&gt;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">atlas_occurrences</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>gliders_2019 <span class="ot">&lt;-</span> gliders_2019 <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(eventDate),             <span class="co"># Extract the year</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">month =</span> <span class="fu">month</span>(eventDate))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>gliders_sf_2019 <span class="ot">&lt;-</span> gliders_2019 <span class="sc">|&gt;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Rebuild gliders_sf_2019for visualisation later</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>gliders_sf_2019 <span class="ot">&lt;-</span> gliders_2019 <span class="sc">|&gt;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>gliders_thin <span class="ot">&lt;-</span> tidysdm<span class="sc">::</span><span class="fu">thin_by_cell</span>(gliders_sf_2019, </span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">raster =</span> combined_rasters)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>gliders_pseudoabs <span class="ot">&lt;-</span> tidysdm<span class="sc">::</span><span class="fu">sample_pseudoabs</span>(</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  gliders_thin,</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">nrow</span>(combined_rasters),</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">raster =</span> combined_rasters,</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"dist_min"</span>, <span class="fu">km2m</span>(<span class="dv">5</span>)))</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the tree cover, elevation values and climate values at the pseudoabs points</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>gliders_events_2019 <span class="ot">&lt;-</span> gliders_pseudoabs <span class="sc">|&gt;</span> </span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">extract</span>(combined_rasters,</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>                   gliders_pseudoabs,</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ID =</span> <span class="cn">FALSE</span>))</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>gliders_events_2019 <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(gliders_events_2019)</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>predictor_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"elevation"</span>, <span class="st">"bio1"</span>, <span class="st">"bio12"</span>, <span class="st">"treecover"</span>)</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>gliders_filtered_2019 <span class="ot">&lt;-</span> </span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>  gliders_events_2019 <span class="sc">|&gt;</span> </span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(predictor_vars, <span class="st">"class"</span>)))</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a><span class="co"># set training and testing data</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>gliders_split_2019 <span class="ot">&lt;-</span> </span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>  gliders_filtered_2019 <span class="sc">|&gt;</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>()</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>gliders_train <span class="ot">&lt;-</span> <span class="fu">training</span>(gliders_split_2019)</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>gliders_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(gliders_split_2019)</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>gliders_cv <span class="ot">&lt;-</span> <span class="fu">spatial_block_cv</span>(gliders_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>gliders_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>  gliders_train, </span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> class <span class="sc">~</span> elevation <span class="sc">+</span> bio1 <span class="sc">+</span> bio12 <span class="sc">+</span> treecover </span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>gliders_models <span class="ot">&lt;-</span></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the workflow_set</span></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_set</span>(</span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">default =</span> gliders_recipe),</span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> <span class="fu">list</span>(</span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">glm =</span> <span class="fu">sdm_spec_glm</span>(),        <span class="co"># the standard glm specs</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">rf =</span> <span class="fu">sdm_spec_rf</span>(),          <span class="co"># rf specs with tuning</span></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">gbm =</span> <span class="fu">sdm_spec_boost_tree</span>(), <span class="co"># boosted tree model (gbm) specs with tuning</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxent =</span> <span class="fu">sdm_spec_maxent</span>()   <span class="co"># maxent specs with tuning</span></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">cross =</span> <span class="cn">TRUE</span> <span class="co"># make all combinations of preproc and models</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">option_add</span>(<span class="at">control =</span> <span class="fu">control_ensemble_grid</span>())</span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2345678</span>) <span class="co"># for reproducability</span></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a>gliders_models_tune <span class="ot">&lt;-</span></span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a>  gliders_models <span class="sc">|&gt;</span></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(<span class="st">"tune_grid"</span>,</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>               <span class="at">resamples =</span> gliders_cv, </span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>               <span class="at">grid =</span> <span class="dv">6</span>,                   <span class="co"># increase for more iterations</span></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a>               <span class="at">metrics =</span> <span class="fu">sdm_metric_set</span>(),</span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a>               <span class="at">control =</span> stacks<span class="sc">::</span><span class="fu">control_stack_grid</span>()</span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123456</span>)</span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a>gliders_stacked <span class="ot">&lt;-</span> </span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stacks</span>() <span class="sc">|&gt;</span>                                <span class="co"># initialize the stack</span></span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_candidates</span>(gliders_models_tune) <span class="sc">|&gt;</span> <span class="co"># add candidate members</span></span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blend_predictions</span>() <span class="sc">|&gt;</span>                     <span class="co"># determine how to combine their predictions</span></span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_members</span>()                              <span class="co"># fit the candidates with nonzero stacking coefficients</span></span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a>gliders_test_predictions_2019 <span class="ot">&lt;-</span></span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a>  gliders_test <span class="sc">%&gt;%</span></span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(gliders_stacked, ., </span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"prob"</span>, </span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a>                    <span class="at">save_pred =</span> <span class="cn">TRUE</span>))</span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a><span class="co"># predict class</span></span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a>gliders_test_predictions_class_2019 <span class="ot">&lt;-</span></span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a>  gliders_test <span class="sc">%&gt;%</span></span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(gliders_stacked, ., </span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"class"</span>, </span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a>                    <span class="at">save_pred =</span> <span class="cn">TRUE</span>))</span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a>prediction_present_2019 <span class="ot">&lt;-</span> <span class="fu">predict_raster</span>(gliders_stacked, </span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a>                                     combined_rasters, </span>
<span id="cb46-115"><a href="#cb46-115" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">type =</span> <span class="st">"prob"</span>,</span>
<span id="cb46-116"><a href="#cb46-116" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">wopt =</span> <span class="fu">list</span>(<span class="at">steps=</span><span class="dv">32</span>))</span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a><span class="do">#####Post fire</span></span>
<span id="cb46-121"><a href="#cb46-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect all greater glider records in that period</span></span>
<span id="cb46-122"><a href="#cb46-122" aria-hidden="true" tabindex="-1"></a>gliders_2024 <span class="ot">&lt;-</span> <span class="fu">galah_call</span>() <span class="sc">|&gt;</span></span>
<span id="cb46-123"><a href="#cb46-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">identify</span>(<span class="st">"Petauroides volans"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-124"><a href="#cb46-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;</span> <span class="dv">2019</span> <span class="sc">&amp;</span> year <span class="sc">&lt;=</span> <span class="dv">2024</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-125"><a href="#cb46-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_apply_profile</span>(ALA) <span class="sc">|&gt;</span></span>
<span id="cb46-126"><a href="#cb46-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_geolocate</span>(se_nsw_bbox, <span class="at">type =</span> <span class="st">"bbox"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-127"><a href="#cb46-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">atlas_occurrences</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>gliders_2024 <span class="ot">&lt;-</span> gliders_2024<span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(eventDate),             <span class="co"># Extract the year</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">month =</span> <span class="fu">month</span>(eventDate))</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>gliders_sf_2024 <span class="ot">&lt;-</span> gliders_2024<span class="sc">|&gt;</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Rebuild gliders_sf_2024 for visualisation later</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>gliders_sf_2024 <span class="ot">&lt;-</span> gliders_2024<span class="sc">|&gt;</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>gliders_2024<span class="sc">$</span>burnt <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(fire_extent, <span class="fu">vect</span>(gliders_sf_2024), <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>gliders_thin <span class="ot">&lt;-</span> tidysdm<span class="sc">::</span><span class="fu">thin_by_cell</span>(gliders_sf_2024, </span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">raster =</span> combined_rasters)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>gliders_pseudoabs <span class="ot">&lt;-</span> tidysdm<span class="sc">::</span><span class="fu">sample_pseudoabs</span>(</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  gliders_thin,</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">nrow</span>(combined_rasters),</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">raster =</span> combined_rasters,</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"dist_min"</span>, <span class="fu">km2m</span>(<span class="dv">5</span>)))</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the tree cover, elevation values and climate values at the pseudoabs points</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>gliders_events_2024 <span class="ot">&lt;-</span> gliders_pseudoabs <span class="sc">|&gt;</span> </span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">extract</span>(combined_rasters,</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>                   gliders_pseudoabs,</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ID =</span> <span class="cn">FALSE</span>))</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>gliders_events_2024 <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(gliders_events_2024)</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>predictor_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"elevation"</span>, <span class="st">"bio1"</span>, <span class="st">"bio12"</span>, <span class="st">"treecover"</span>, <span class="st">"fire_extent"</span>)</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>gliders_filtered_2024 <span class="ot">&lt;-</span> </span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>  gliders_events_2024 <span class="sc">|&gt;</span> </span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(predictor_vars, <span class="st">"class"</span>)))</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>combined_rasters <span class="ot">&lt;-</span> combined_rasters[[predictor_vars]]</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a><span class="co"># set training and testing data</span></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>gliders_split_2024 <span class="ot">&lt;-</span> </span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>  gliders_filtered_2024 <span class="sc">|&gt;</span></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>()</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>gliders_train <span class="ot">&lt;-</span> <span class="fu">training</span>(gliders_split_2024)</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>gliders_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(gliders_split_2024)</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>gliders_cv <span class="ot">&lt;-</span> <span class="fu">spatial_block_cv</span>(gliders_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>gliders_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>  gliders_train, </span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> class <span class="sc">~</span> elevation <span class="sc">+</span> bio1 <span class="sc">+</span> bio12 <span class="sc">+</span> treecover <span class="sc">+</span> fire_extent</span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>gliders_models <span class="ot">&lt;-</span></span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the workflow_set</span></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_set</span>(</span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">default =</span> gliders_recipe),</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> <span class="fu">list</span>(</span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">glm =</span> <span class="fu">sdm_spec_glm</span>(),        <span class="co"># the standard glm specs</span></span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">rf =</span> <span class="fu">sdm_spec_rf</span>(),          <span class="co"># rf specs with tuning</span></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">gbm =</span> <span class="fu">sdm_spec_boost_tree</span>(), <span class="co"># boosted tree model (gbm) specs with tuning</span></span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxent =</span> <span class="fu">sdm_spec_maxent</span>()   <span class="co"># maxent specs with tuning</span></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">cross =</span> <span class="cn">TRUE</span> <span class="co"># make all combinations of preproc and models</span></span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">option_add</span>(<span class="at">control =</span> <span class="fu">control_ensemble_grid</span>())</span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2345678</span>) <span class="co"># for reproducability</span></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>gliders_models_tune <span class="ot">&lt;-</span></span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a>  gliders_models <span class="sc">|&gt;</span></span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(<span class="st">"tune_grid"</span>,</span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>               <span class="at">resamples =</span> gliders_cv, </span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>               <span class="at">grid =</span> <span class="dv">6</span>,                   <span class="co"># increase for more iterations</span></span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>               <span class="at">metrics =</span> <span class="fu">sdm_metric_set</span>(),</span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a>               <span class="at">control =</span> stacks<span class="sc">::</span><span class="fu">control_stack_grid</span>()</span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123456</span>)</span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a>gliders_stacked <span class="ot">&lt;-</span> </span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stacks</span>() <span class="sc">|&gt;</span>                                <span class="co"># initialize the stack</span></span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_candidates</span>(gliders_models_tune) <span class="sc">|&gt;</span> <span class="co"># add candidate members</span></span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blend_predictions</span>() <span class="sc">|&gt;</span>                     <span class="co"># determine how to combine their predictions</span></span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_members</span>()                              <span class="co"># fit the candidates with nonzero stacking coefficients</span></span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a>gliders_test_predictions_2024 <span class="ot">&lt;-</span></span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a>  gliders_test <span class="sc">%&gt;%</span></span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(gliders_stacked, ., </span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"prob"</span>, </span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a>                    <span class="at">save_pred =</span> <span class="cn">TRUE</span>))</span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a><span class="co"># predict class</span></span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a>gliders_test_predictions_class_2024<span class="ot">&lt;-</span></span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a>  gliders_test <span class="sc">%&gt;%</span></span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(gliders_stacked, ., </span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"class"</span>, </span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a>                    <span class="at">save_pred =</span> <span class="cn">TRUE</span>))</span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-122"><a href="#cb48-122" aria-hidden="true" tabindex="-1"></a>prediction_present_2024 <span class="ot">&lt;-</span> <span class="fu">predict_raster</span>(gliders_stacked, </span>
<span id="cb48-123"><a href="#cb48-123" aria-hidden="true" tabindex="-1"></a>                                         combined_rasters, </span>
<span id="cb48-124"><a href="#cb48-124" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">type =</span> <span class="st">"prob"</span>,</span>
<span id="cb48-125"><a href="#cb48-125" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">wopt =</span> <span class="fu">list</span>(<span class="at">steps=</span><span class="dv">32</span>))</span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a>habitat_diff <span class="ot">&lt;-</span> prediction_present_2024 <span class="sc">-</span> prediction_present_2019</span>
<span id="cb48-128"><a href="#cb48-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-129"><a href="#cb48-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-130"><a href="#cb48-130" aria-hidden="true" tabindex="-1"></a>fire_mask <span class="ot">&lt;-</span> (fire_extent <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">&amp;</span> (fire_extent <span class="sc">&lt;=</span> <span class="dv">5</span>)</span>
<span id="cb48-131"><a href="#cb48-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-132"><a href="#cb48-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply mask to habitat difference raster</span></span>
<span id="cb48-133"><a href="#cb48-133" aria-hidden="true" tabindex="-1"></a>intersect_raster <span class="ot">&lt;-</span> <span class="fu">mask</span>(habitat_diff, fire_mask, <span class="at">maskvalue=</span><span class="dv">0</span>)</span>
<span id="cb48-134"><a href="#cb48-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-135"><a href="#cb48-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-136"><a href="#cb48-136" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb48-137"><a href="#cb48-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spatraster</span>(<span class="at">data =</span> intersect_raster, </span>
<span id="cb48-138"><a href="#cb48-138" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">fill =</span> .pred_presence)) <span class="sc">+</span></span>
<span id="cb48-139"><a href="#cb48-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_whitebox_c</span>(<span class="at">palette =</span> <span class="st">"muted"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb48-140"><a href="#cb48-140" aria-hidden="true" tabindex="-1"></a>                        <span class="at">na.value =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb48-141"><a href="#cb48-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colorbar</span>(<span class="at">title=</span><span class="st">"</span><span class="sc">\n</span><span class="st">Habitat</span><span class="sc">\n</span><span class="st">Suitability</span><span class="sc">\n</span><span class="st">Difference"</span>)) <span class="sc">+</span></span>
<span id="cb48-142"><a href="#cb48-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Difference in predicted habitat suitability for fire impacted areas"</span>) <span class="sc">+</span></span>
<span id="cb48-143"><a href="#cb48-143" aria-hidden="true" tabindex="-1"></a>  pilot<span class="sc">::</span><span class="fu">theme_pilot</span>(<span class="at">grid=</span><span class="st">"hv"</span>) <span class="sc">+</span></span>
<span id="cb48-144"><a href="#cb48-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb48-145"><a href="#cb48-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb48-146"><a href="#cb48-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</details>
<details>
<summary style="color: #E06E53;">
<p>Expand for session info</p>
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.2 (2024-10-31 ucrt)
 os       Windows 11 x64 (build 22631)
 system   x86_64, mingw32
 ui       RTerm
 language (EN)
 collate  English_Australia.utf8
 ctype    English_Australia.utf8
 tz       Australia/Sydney
 date     2025-02-20
 pandoc   3.2 @ C:/Program Files/RStudio/resources/app/bin/quarto/bin/tools/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────────
 package       * version date (UTC) lib source
 broom         * 1.0.7   2024-09-26 [1] CRAN (R 4.4.2)
 dials         * 1.3.0   2024-07-30 [1] CRAN (R 4.4.2)
 dplyr         * 1.1.4   2023-11-17 [1] CRAN (R 4.4.2)
 elevatr       * 0.99.0  2023-09-12 [1] CRAN (R 4.4.2)
 forcats       * 1.0.0   2023-01-29 [1] CRAN (R 4.4.2)
 galah         * 2.1.0   2024-11-19 [1] CRAN (R 4.4.2)
 geodata       * 0.6-2   2024-06-10 [1] CRAN (R 4.4.2)
 ggplot2       * 3.5.1   2024-04-23 [1] CRAN (R 4.4.2)
 glmnet        * 4.1-8   2023-08-22 [1] CRAN (R 4.4.2)
 here          * 1.0.1   2020-12-13 [1] CRAN (R 4.4.2)
 htmltools     * 0.5.8.1 2024-04-04 [1] CRAN (R 4.4.2)
 infer         * 1.0.7   2024-03-25 [1] CRAN (R 4.4.2)
 lubridate     * 1.9.4   2024-12-08 [1] CRAN (R 4.4.2)
 Matrix        * 1.7-1   2024-10-18 [2] CRAN (R 4.4.2)
 maxnet        * 0.1.4   2021-07-09 [1] CRAN (R 4.4.2)
 modeldata     * 1.4.0   2024-06-19 [1] CRAN (R 4.4.2)
 ozmaps        * 0.4.5   2021-08-03 [1] CRAN (R 4.4.2)
 parsnip       * 1.2.1   2024-03-22 [1] CRAN (R 4.4.2)
 purrr         * 1.0.2   2023-08-10 [1] CRAN (R 4.4.2)
 ranger        * 0.17.0  2024-11-08 [1] CRAN (R 4.4.2)
 readr         * 2.1.5   2024-01-10 [1] CRAN (R 4.4.2)
 recipes       * 1.1.0   2024-07-04 [1] CRAN (R 4.4.2)
 rsample       * 1.2.1   2024-03-25 [1] CRAN (R 4.4.2)
 scales        * 1.3.0   2023-11-28 [1] CRAN (R 4.4.2)
 sessioninfo   * 1.2.2   2021-12-06 [1] CRAN (R 4.4.2)
 sf            * 1.0-19  2024-11-05 [1] CRAN (R 4.4.2)
 spatialsample * 0.6.0   2024-10-02 [1] CRAN (R 4.4.2)
 stacks        * 1.0.5   2024-07-22 [1] CRAN (R 4.4.2)
 stringr       * 1.5.1   2023-11-14 [1] CRAN (R 4.4.2)
 terra         * 1.8-10  2025-01-14 [1] CRAN (R 4.4.2)
 tibble        * 3.2.1   2023-03-20 [1] CRAN (R 4.4.2)
 tidymodels    * 1.2.0   2024-03-25 [1] CRAN (R 4.4.2)
 tidyr         * 1.3.1   2024-01-24 [1] CRAN (R 4.4.2)
 tidysdm       * 0.9.5   2024-06-23 [1] CRAN (R 4.4.2)
 tidyterra     * 0.6.2   2025-01-08 [1] CRAN (R 4.4.2)
 tidyverse     * 2.0.0   2023-02-22 [1] CRAN (R 4.4.2)
 tune          * 1.2.1   2024-04-18 [1] CRAN (R 4.4.2)
 workflows     * 1.1.4   2024-02-19 [1] CRAN (R 4.4.2)
 workflowsets  * 1.1.0   2024-03-21 [1] CRAN (R 4.4.2)
 xgboost       * 1.7.8.1 2024-07-24 [1] CRAN (R 4.4.2)
 yardstick     * 1.3.1   2024-03-21 [1] CRAN (R 4.4.2)

 [1] C:/Users/wri211/AppData/Local/R/win-library/4.4
 [2] C:/Program Files/R/R-4.4.2/library

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
</details>
</section>
</section>
</div>
</div>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>https://www.dbca.wa.gov.au/wildlife-and-ecosystems/fire-and-environment/fire-plants-and-vegetation<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>https://www.sciencedirect.com/science/article/pii/S0016718521000233<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>https://www.bushheritage.org.au/what-we-do/our-challenge/fire-management<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>https://wwf.org.au/blogs/new-study-confirms-indigenous-fire-management-equals-success/<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>https://wwf.org.au/what-we-do/australian-bushfires/<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>https://www.nature.com/articles/s41586-024-08174-6<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Rasters are grids of spatial data, where each pixel contains a value representing the information we’re interested in. <a href="https://labs.ala.org.au/posts/2024-04-30_sdm-tidymodels/#download-environmental-data">Check out this baisc example</a>.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>